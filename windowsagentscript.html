<powershell><br>#requires -version 4.0<br><br># PowerShell 4 or up is required to run this script<br># This script detects platform and architecture.  It then downloads and installs the relevant Deep Security Agent package<br><br>if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] \"Administrator\")) {<br>   Write-Warning \"You are not running as an Administrator. Please try again with admin privileges.\"<br>   exit 1<br>}<br><br>$managerUrl=\"https://shield.cloudcreator.co.nz:443/\"<br><br>$env:LogPath = \"$env:appdata\\Trend Micro\\Deep Security Agent\\installer\"<br>New-Item -path $env:LogPath -type directory<br>Start-Transcript -path \"$env:LogPath\\dsa_deploy.log\" -append<br><br>echo \"$(Get-Date -format T) - DSA download started\"<br>if ( [intptr]::Size -eq 8 ) { <br>   $sourceUrl=-join($managerUrl, \"software/agent/Windows/x86_64/agent.msi\") }<br>else {<br>   $sourceUrl=-join($managerUrl, \"software/agent/Windows/i386/agent.msi\") }<br>echo \"$(Get-Date -format T) - Download Deep Security Agent Package\" $sourceUrl<br><br>$ACTIVATIONURL=\"dsm://shield.cloudcreator.co.nz:4120/\"<br><br>$WebClient = New-Object System.Net.WebClient<br><br># Add agent version control info<br>$WebClient.Headers.Add(\"Agent-Version-Control\", \"on\")<br>$WebClient.QueryString.Add(\"tenantID\", \"1258\")<br>$WebClient.QueryString.Add(\"windowsVersion\", (Get-CimInstance Win32_OperatingSystem).Version)<br>$WebClient.QueryString.Add(\"windowsProductType\", (Get-CimInstance Win32_OperatingSystem).ProductType)<br><br>[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;<br><br>Try<br>{<br>     $WebClient.DownloadFile($sourceUrl,  \"$env:temp\\agent.msi\")<br>} Catch [System.Net.WebException]<br>{<br>      echo \" Please check that your Deep Security Manager TLS certificate is signed by a trusted root certificate authority.\"<br>      exit 2;<br>}<br><br>if ( (Get-Item \"$env:temp\\agent.msi\").length -eq 0 ) {<br>    echo \"Failed to download the Deep Security Agent. Please check if the package is imported into the Deep Security Manager. \"<br> exit 1<br>}<br>echo \"$(Get-Date -format T) - Downloaded File Size:\" (Get-Item \"$env:temp\\agent.msi\").length<br><br>if ( (Get-AuthenticodeSignature \"$env:temp\\agent.msi\").Status -ne \"Valid\" ) {<br>    echo \"The digital signature of Deep Security Agent is invalid.\"<br>    exit 1<br>}<br><br>echo \"$(Get-Date -format T) - DSA install started\"<br>echo \"$(Get-Date -format T) - Installer Exit Code:\" (Start-Process -FilePath msiexec -ArgumentList \"/i $env:temp\\agent.msi /qn ADDLOCAL=ALL /l*v `\"$env:LogPath\\dsa_install.log`\"\" -Wait -PassThru).ExitCode <br>echo \"$(Get-Date -format T) - DSA activation started\"<br><br>Start-Sleep -s 50<br>& $Env:ProgramFiles\"\\Trend Micro\\Deep Security Agent\\dsa_control\" -r<br>& $Env:ProgramFiles\"\\Trend Micro\\Deep Security Agent\\dsa_control\" -a $ACTIVATIONURL \"tenantID:D94F1DF0-D7FC-78BA-32A7-80D26586C3DD\" \"policyid:6\"<br>#& $Env:ProgramFiles\"\\Trend Micro\\Deep Security Agent\\dsa_control\" -a dsm://shield.cloudcreator.co.nz:4120/ \"policyid:6\"<br>Stop-Transcript<br>echo \"$(Get-Date -format T) - DSA Deployment Finished\"<br></powershell>